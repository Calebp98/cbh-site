---
import "../styles/global.css";
const currentYear = new Date().getFullYear();
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cambridge Biosecurity Hub</title>
  </head>

  <body>
    <div class="container">
      <div class="mask-sketch"></div>
      <div class="far-uvc-sketch"></div>
      <div class="lab-robot-sketch"></div>
      <div class="pipette-sketch"></div>
      <div class="blood-cells-sketch"></div>
      <div class="chromosone-sketch"></div>
      <div class="crispr-sketch"></div>
      <div class="lab-coat-sketch"></div>
      <div class="sequencer-sketch"></div>
      <div class="test-tubes-sketch"></div>
      <header>
        <h1 id="title-text">Cambridge Biosecurity Hub</h1>
        <div class="typing-container">
          <span class="typing-text"></span>
          <span class="cursor">|</span>
        </div>
      </header>

      <section>
        <h2>About CBH</h2>
        <p>
          The Cambridge Biosecurity Hub (CBH) is a team of researchers
          investigating and raising awareness of the risks associated with
          rapidly developing biotechnologies. Our projects aim to make progress
          on both technical and policy issues within biosecurity.
        </p>
      </section>

      <section>
        <h2>Current Projects</h2>
        <div class="projects-grid">
          <div class="project-card" data-color="coral-red">
            <div class="project-header">
              <h4>AIxBio Fellowship</h4>
              <button class="expand-btn" aria-label="Expand project details">
                <span class="expand-icon">+</span>
              </button>
            </div>
            <div class="project-content">
              <p>
                <strong
                  >CBH is collaborating with ERA to run the first AIxBio
                  Fellowship</strong
                >
              </p>
              <p>
                It is an 8-week, fully funded research fellowship at Cambridge,
                UK, from January 26 - March 20, 2026.
              </p>
              <p>
                Our aim is for fellows to work on concrete projects mitigating
                biosecurity risks, including those amplified by frontier AI.
              </p>
              <p>
                For more information visit <a href="https://aixbiosecurity.com"
                  >aixbiosecurity.com</a
                >
              </p>
              <p>
                <strong>Applications for fellows close November 5th</strong>
              </p>
            </div>
          </div>
        </div>

        <h3>Previous Projects:</h3>
        <div class="projects-grid">
          <div class="project-card" data-color="sage-green">
            <div class="project-header">
              <h4>Biosecurity Fundamentals Reading Groups</h4>
              <button class="expand-btn" aria-label="Expand project details">
                <span class="expand-icon">+</span>
              </button>
            </div>
            <div class="project-content">
              <p>
                In-person reading groups focused on fundamental biosecurity
                concepts and research.
              </p>
            </div>
          </div>

          <div class="project-card" data-color="burnt-orange">
            <div class="project-header">
              <h4>Biosecurity Research Sprints</h4>
              <button class="expand-btn" aria-label="Expand project details">
                <span class="expand-icon">+</span>
              </button>
            </div>
            <div class="project-content">
              <p>
                Intensive research sprints tackling specific biosecurity
                challenges and policy issues.
              </p>
            </div>
          </div>

          <div class="project-card" data-color="deep-purple">
            <div class="project-header">
              <h4>Cambridge Pandemic Prevention Symposium</h4>
              <button class="expand-btn" aria-label="Expand project details">
                <span class="expand-icon">+</span>
              </button>
            </div>
            <div class="project-content">
              <p>
                The Cambridge Pandemic Prevention Symposium was held at Jesus
                College on 7th October 2024. We had >100 attendees and a series
                of impressive speakers including Dr Cassidy Nelson (CLTR), Dr
                Ewan Harrison (University of Cambridge), Dr Nicole Wheeler
                (University of Birmingham) and Dr Sana Zakaria (RAND Europe).
              </p>
            </div>
          </div>
        </div>
      </section>

      <section>
        <h2>Meet the Team</h2>
        <div class="team">
          <div class="team-member">
            <h3>Dr Grace Braithwaite</h3>
            <img
              src="/cbh-site/profile_pics/grace.webp"
              alt="Grace Braithwaite"
              class="profile-image"
              data-bio="Grace is a medical doctor with a masters in public health. She now runs Cambridge Biosecurity Hub fulltime."
            />
            <p>Founder</p>
            <p class="bio-text">
              Grace is a medical doctor with a masters in public health. She now
              runs Cambridge Biosecurity Hub fulltime.
            </p>
          </div>
          <div class="team-member">
            <h3>Sandy Hickson</h3>
            <img
              src="/cbh-site/profile_pics/sandy.webp"
              alt="Sandy Hickson"
              class="profile-image"
              data-bio="Sandy is a PhD student in genetics and bioinformatics at the University of Cambridge."
            />
            <p>Founder</p>
            <p class="bio-text">
              Sandy is a PhD student in genetics and bioinformatics at the
              University of Cambridge.
            </p>
          </div>
          <div class="team-member">
            <h3>Dr Phil Palmer</h3>
            <img
              src="/cbh-site/profile_pics/phil.webp"
              alt="Phil Palmer"
              class="profile-image"
              data-bio="Phil has a PhD in bioinformatics from the University of Cambridge."
            />
            <p>Research Lead</p>
            <p class="bio-text">
              Phil has a PhD in bioinformatics from the University of Cambridge.
            </p>
          </div>
          <div class="team-member">
            <h3>Dr Richard Moulange</h3>
            <img
              src="/cbh-site/profile_pics/richard.webp"
              alt="Richard Moulange"
              class="profile-image"
              data-bio="Richard has a PhD in machine learning from the University of Cambridge, and works on AIxBio Policy at the Centre for Long-Term Resilience - a think tank based in London."
            />
            <p>Research Affiliate</p>
            <p class="bio-text">
              Richard has a PhD in machine learning from the University of
              Cambridge, and works on AIxBio Policy at the Centre for Long-Term
              Resilience - a think tank based in London.
            </p>
          </div>
        </div>
      </section>

      <footer>
        <p>
          CBH is a project of the community interest company registered as
          Meridian Impact CIC at Companies House (company number 13653958).
        </p>
        <p>
          © {currentYear}, Cambridge Biosecurity Hub / Meridian CIC. All rights
          reserved.
        </p>
        <p>
          <a href="#">Code of Conduct</a> | <a href="#"
            >Community Health reporting form</a
          >
        </p>
      </footer>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // DNA Transcription animation for all headers
        const headers = document.querySelectorAll(
          "h1, h2, h3"
        ) as NodeListOf<HTMLElement>;
        const dnaBases = ["A", "C", "G", "T"];
        const rnaBases = ["A", "C", "G", "U"];

        let headerAnimations: Array<{
          element: HTMLElement;
          targetText: string;
          currentSequence: string[];
          targetChars: string[];
          animationIndex: number;
        }> = [];

        // Initialize animations for each header
        headers.forEach((header, index) => {
          const targetText = header.textContent || "";
          headerAnimations.push({
            element: header,
            targetText: targetText,
            currentSequence: [],
            targetChars: targetText.split(""),
            animationIndex: 0,
          });
        });

        let titleAnimationSpeed = 250; // More movement - changes every 250ms (4 times per second)

        function generateRandomSequence(
          targetText: string,
          bases: string[]
        ): string[] {
          return targetText.split("").map((char) => {
            if (char === " ") {
              return " "; // Keep spaces as spaces
            }
            return bases[Math.floor(Math.random() * bases.length)];
          });
        }

        function wrapBasesWithColors(sequence: string[]): string {
          return sequence
            .map((base) => {
              if (base === " ") {
                return " "; // Keep spaces as plain spaces
              }
              const className = `base-${base.toLowerCase()}`;
              return `<span class="${className}">${base}</span>`;
            })
            .join("");
        }

        function dnaTranscription() {
          let allComplete = true;

          headerAnimations.forEach((animation, headerIndex) => {
            const { element, targetText, targetChars } = animation;

            if (animation.animationIndex === 0) {
              // Start with DNA sequence
              animation.currentSequence = generateRandomSequence(
                targetText,
                dnaBases
              );
              element.innerHTML = wrapBasesWithColors(
                animation.currentSequence
              );
            } else if (animation.animationIndex === 1) {
              // Another DNA sequence variation
              animation.currentSequence = generateRandomSequence(
                targetText,
                dnaBases
              );
              element.innerHTML = wrapBasesWithColors(
                animation.currentSequence
              );
            } else if (animation.animationIndex === 2) {
              // Convert to RNA
              animation.currentSequence = animation.currentSequence.map(
                (base) => (base === "T" ? "U" : base)
              );
              element.innerHTML = wrapBasesWithColors(
                animation.currentSequence
              );
            } else if (animation.animationIndex === 3) {
              // Another RNA variation
              animation.currentSequence = generateRandomSequence(
                targetText,
                rnaBases
              );
              element.innerHTML = wrapBasesWithColors(
                animation.currentSequence
              );
            } else if (animation.animationIndex === 4) {
              // Start introducing target characters
              const halfLength = Math.floor(targetChars.length / 2);
              for (let i = 0; i < halfLength; i++) {
                const randomIndex = Math.floor(
                  Math.random() * animation.currentSequence.length
                );
                animation.currentSequence[randomIndex] =
                  targetChars[randomIndex];
              }
              element.innerHTML = wrapBasesWithColors(
                animation.currentSequence
              );
            } else if (animation.animationIndex === 5) {
              // Final result
              element.textContent = targetText;
              return; // This header is complete
            }

            animation.animationIndex++;
            allComplete = false;
          });

          if (!allComplete) {
            setTimeout(dnaTranscription, titleAnimationSpeed);
          }
        }

        // Start DNA transcription animation for all headers
        dnaTranscription();

        // Typing animation for slogan
        const typingText = document.querySelector(
          ".typing-text"
        ) as HTMLElement;
        const texts = [
          "Safeguarding Biological Research.",
          "Working to usher in a future of safe and transformative biotechnologies.",
        ];

        let textIndex = 0;
        let charIndex = 0;
        let isDeleting = false;
        let typingSpeed = 33; // 3x faster (100ms -> 33ms)
        let deleteSpeed = 16; // 3x faster (50ms -> 16ms)
        let pauseTime = 3000; // 3x longer pause before deleting

        function typeText() {
          const currentText = texts[textIndex];

          if (isDeleting) {
            // Delete entire line at once
            typingText.textContent = "";
            charIndex = 0;
            isDeleting = false;
            textIndex = (textIndex + 1) % texts.length;
            typingSpeed = 200; // Short pause before next text
          } else {
            typingText.textContent = currentText.substring(0, charIndex + 1);
            charIndex++;
            typingSpeed = 33; // Fast typing
          }

          if (!isDeleting && charIndex === currentText.length) {
            typingSpeed = pauseTime;
            isDeleting = true;
          }

          setTimeout(typeText, typingSpeed);
        }

        // Start typing animation for slogan
        typeText();

        // Project cards functionality
        const projectCards = document.querySelectorAll(".project-card");

        projectCards.forEach((card) => {
          card.addEventListener("click", function (event) {
            const target = event.target as HTMLElement;
            const content = card.querySelector(
              ".project-content"
            ) as HTMLElement;
            const icon = card.querySelector(".expand-icon") as HTMLElement;

            card.classList.toggle("expanded");

            if (card.classList.contains("expanded")) {
              icon.textContent = "−";
              content.style.maxHeight = content.scrollHeight + "px";
            } else {
              icon.textContent = "+";
              content.style.maxHeight = "0";
            }
          });
        });

        // Speech bubble functionality for team members
        const profileImages = document.querySelectorAll(".profile-image");
        let currentBubble: HTMLElement | null = null;

        function removeCurrentBubble() {
          if (currentBubble) {
            currentBubble.remove();
            currentBubble = null;
          }
        }

        function showBubble(img: HTMLImageElement) {
          // Remove any existing bubble
          removeCurrentBubble();

          const bio = img.getAttribute("data-bio");
          if (!bio) return;

          // Create new speech bubble
          const bubble = document.createElement("div");
          bubble.className = "speech-bubble";
          bubble.textContent = bio;

          // Add bubble to body for proper positioning
          document.body.appendChild(bubble);

          // Get image position
          const imgRect = img.getBoundingClientRect();

          // Position bubble
          positionBubble(bubble, imgRect);

          currentBubble = bubble;
        }

        function positionBubble(bubble: HTMLElement, imgRect: DOMRect) {
          const viewportWidth = window.innerWidth;
          const viewportHeight = window.innerHeight;
          const margin = 20;
          const isMobile = viewportWidth <= 768;

          // On mobile, use a simpler positioning approach
          if (isMobile) {
            bubble.classList.remove("tail-right", "tail-left");
            bubble.classList.add("tail-bottom");

            // Position above the image initially
            let topPosition = imgRect.top - 200; // Use estimated height
            let leftPosition = imgRect.left + imgRect.width / 2 - 125; // Center with estimated width

            // Ensure bubble stays within viewport horizontally
            if (leftPosition < margin) {
              leftPosition = margin;
            } else if (leftPosition + 250 > viewportWidth - margin) {
              leftPosition = viewportWidth - 250 - margin;
            }

            bubble.style.left = `${leftPosition}px`;
            bubble.style.top = `${topPosition}px`;

            // Now get actual dimensions and adjust if needed
            setTimeout(() => {
              const bubbleRect = bubble.getBoundingClientRect();
              const bubbleWidth = bubbleRect.width;
              const bubbleHeight = bubbleRect.height;

              // Only adjust if we got valid dimensions
              if (bubbleWidth > 0 && bubbleHeight > 0) {
                // Recalculate position with actual dimensions
                let finalTopPosition = imgRect.top - bubbleHeight - 15;

                // If not enough space above, position below
                if (finalTopPosition < margin) {
                  finalTopPosition = imgRect.bottom + 15;
                  bubble.classList.remove("tail-bottom");
                  bubble.classList.add("tail-top");
                }

                let finalLeftPosition =
                  imgRect.left + imgRect.width / 2 - bubbleWidth / 2;

                // Ensure bubble stays within viewport
                if (finalLeftPosition < margin) {
                  finalLeftPosition = margin;
                } else if (
                  finalLeftPosition + bubbleWidth >
                  viewportWidth - margin
                ) {
                  finalLeftPosition = viewportWidth - bubbleWidth - margin;
                }

                bubble.style.left = `${finalLeftPosition}px`;
                bubble.style.top = `${finalTopPosition}px`;
              }
            }, 50);

            return;
          }

          // Desktop positioning logic
          const bubbleRect = bubble.getBoundingClientRect();
          const bubbleWidth = bubbleRect.width;
          const bubbleHeight = bubbleRect.height;

          const spaceOnRight = viewportWidth - imgRect.right;
          const showOnRight = spaceOnRight >= bubbleWidth + margin;

          // Position horizontally
          if (showOnRight) {
            bubble.classList.add("tail-right");
            bubble.classList.remove("tail-left");
            bubble.style.left = `${imgRect.right + 10}px`;
          } else {
            bubble.classList.add("tail-left");
            bubble.classList.remove("tail-right");
            bubble.style.left = `${Math.max(margin, imgRect.left - bubbleWidth - 10)}px`;
          }

          // Position vertically - center relative to image, but keep within viewport
          let topPosition = imgRect.top + imgRect.height / 2 - bubbleHeight / 2;

          // Ensure bubble doesn't go above viewport
          if (topPosition < margin) {
            topPosition = margin;
          }

          // Ensure bubble doesn't go below viewport
          if (topPosition + bubbleHeight > viewportHeight - margin) {
            topPosition = viewportHeight - bubbleHeight - margin;
          }

          bubble.style.top = `${topPosition}px`;
        }

        profileImages.forEach((image) => {
          const img = image as HTMLImageElement;
          const bio = img.getAttribute("data-bio");

          if (!bio) return;

          // Check if device is mobile
          const isMobile = window.innerWidth <= 768;

          // Only add speech bubble events on desktop
          if (!isMobile) {
            // Desktop hover events
            img.addEventListener("mouseenter", function () {
              showBubble(img);
            });

            img.addEventListener("mouseleave", function () {
              removeCurrentBubble();
            });

            // Click event for desktop
            img.addEventListener("click", function (e) {
              showBubble(img);
            });
          }

          // Remove bubble on scroll or resize
          img.addEventListener("scroll", removeCurrentBubble);
        });

        // Remove bubble on window resize or scroll
        window.addEventListener("resize", removeCurrentBubble);
        window.addEventListener("scroll", removeCurrentBubble);
      });
    </script>
  </body>
</html>
